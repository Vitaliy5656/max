Архитектурный апгрейд MAX AI: Душа, Реестр и Паранойя.

Привет, коллега. Мы выходим на новый уровень разработки нашего AI-агента (MAX). Текущая ситуация: у нас есть мощный "мозг" (Qwen 2.5 14B Uncensored) и быстрая реакция, но архитектурно это всё еще "чат-бот", а не "агент".

Нам нужно внедрить три фундаментальных системы. Посмотри на код и реши, как это элегантно вписать в текущую структуру (скорее всего в src/core/).

Вот суть того, что нам нужно:

1. Модуль "Душа" (Meta-Cognition Layer)
Проблема: Макс страдает "амнезией цели". Он отвечает на текущий вопрос, но не помнит, что мы глобально строим ОС уже неделю. Он мыслит паттернами, а не сутью. Решение: Нам нужен менеджер состояния (BDI — Belief, Desire, Intention).

Файл Души (data/soul.json): Это JSON, где хранятся не просто логи, а "Аксиомы" и "Инсайты".

Пример Аксиомы: "Простота лучше сложности", "Локальное лучше облачного".

Пример Цели: "Мы сейчас пилим файловую систему, не отвлекайся".

Механика: Напиши класс SoulManager. Он должен читать этот файл и генерировать динамическую вставку (System Prompt Injection).

Важно: Инъекция должна быть на английском (так модель лучше слушается), даже если чат на русском. Она должна говорить модели: "Смотри на Аксиомы. Если паттерн противоречит эффективности — нарушай паттерн" (First Principles Thinking).

2. Реестр Инструментов (The Swiss Army Knife)
Проблема: Мы не хотим хардкодить функции внутри логики чата. Нам нужна гибкость. Решение: Паттерн "Магнитная рукоятка".

Напиши Реестр (Registry) на декораторах (@registry.register).

Магия: Когда я вешаю декоратор на обычную Python-функцию (например, read_file(path: str)), реестр должен сам прочитать аннотации типов и докстринги, и сгенерировать JSON Schema для LLM.

Это нужно, чтобы Qwen/Dolphin понимали, как вызвать инструмент, без ручного написания схем.

На будущее: Держи в голове, что потом эти "инструменты" будут использоваться в визуальном редакторе (как ноды в n8n), так что они должны быть изолированы.

3. Безопасность и Файловая Система (The Straitjacket)
Проблема: У нас Abliterated модель. У неё нет тормозов. Если она решит, что для оптимизации проекта надо удалить папку src, она это сделает. Решение: Нам нужна параноидальная прослойка безопасности при работе с файлами.

Hard Sandbox: Определи жесткую корневую папку (workspace). Любая попытка выйти за её пределы (../windows) должна вызывать SecurityError. Никаких исключений.

Shadow Copy (Авто-бэкап): Инструмент write_file никогда не должен перезаписывать файл "в тупую". Сначала — копия оригинала в .bak с таймстемпом. Только потом запись. Это наша страховка от галлюцинаций кода.

Human-in-the-Loop (Цербер): Деструктивные действия (удаление, перезапись критических файлов) не должны выполняться "автоматом". Код должен возвращать статус, требующий подтверждения (или просто падать с ошибкой "Требуется подтверждение", если UI пока нет).

Итого: Мне нужны 3 модуля (Душа, Реестр, Файловые тулы) и понимание, как ты их свяжешь с lm_client.py или основным циклом чата. Реализуй это красиво, с типизацией и обработкой ошибок. Жду код.